<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug: Realtime Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .container {
      background: #1e293b;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    h1 { color: #60a5fa; }
    h2 { color: #34d399; margin-top: 0; }
    .status { 
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }
    .success { background: #065f46; border-left: 4px solid #10b981; }
    .error { background: #7f1d1d; border-left: 4px solid #ef4444; }
    .info { background: #1e3a8a; border-left: 4px solid #3b82f6; }
    .warning { background: #78350f; border-left: 4px solid #f59e0b; }
    .data-item {
      background: #334155;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border-left: 3px solid #60a5fa;
    }
    .visible { border-left-color: #10b981; }
    .hidden { border-left-color: #6b7280; opacity: 0.7; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2563eb; }
    .log {
      background: #0f172a;
      padding: 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üîç Supabase Realtime Debug Tool</h1>
  
  <div class="container">
    <h2>üìä Connection Status</h2>
    <div id="connection-status" class="status info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
  </div>

  <div class="container">
    <h2>üéì Education Data</h2>
    <button onclick="fetchEducation()">üîÑ Refresh Data</button>
    <div id="education-data"></div>
  </div>

  <div class="container">
    <h2>üì° Realtime Events</h2>
    <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    <div id="realtime-log" class="log"></div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://tncaevvnicaygulracft.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuY2FldnZuaWNheWd1bHJhY2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MTU5NDgsImV4cCI6MjA4MDA5MTk0OH0.wKhD7t7mK_rmCiKZwS97ZTQhlcWk-BeAc208oCSsg1s';

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById('connection-status');
    const educationEl = document.getElementById('education-data');
    const logEl = document.getElementById('realtime-log');

    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString('th-TH');
      const color = {
        info: '#3b82f6',
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b'
      }[type] || '#3b82f6';
      
      logEl.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${time}] ${message}`);
    }

    function clearLogs() {
      logEl.innerHTML = '';
      log('Logs cleared', 'info');
    }

    async function fetchEducation() {
      try {
        log('üîÑ Fetching education data...', 'info');
        
        const { data, error } = await client
          .from('education')
          .select('*')
          .order('order_index', { ascending: true });

        if (error) throw error;

        log(`‚úÖ Fetched ${data.length} records`, 'success');
        
        educationEl.innerHTML = data.map(item => `
          <div class="data-item ${item.is_visible ? 'visible' : 'hidden'}">
            <strong>${item.title_th}</strong> (${item.year})
            <br>
            <small>
              ${item.is_visible ? 'üåê ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö' : 'üëÅÔ∏è ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà'} | 
              Order: ${item.order_index} | 
              ${item.badge || 'No badge'}
            </small>
          </div>
        `).join('');

        // Show visible count
        const visibleCount = data.filter(d => d.is_visible).length;
        log(`üìä Visible: ${visibleCount}/${data.length}`, 'info');
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        educationEl.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
      }
    }

    // Setup Realtime
    async function setupRealtime() {
      try {
        log('üì° Setting up Realtime subscription...', 'info');
        
        const channel = client
          .channel('education-changes')
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'education' },
            (payload) => {
              log(`üîî Realtime event: ${payload.eventType}`, 'success');
              log(`   Data: ${JSON.stringify(payload.new || payload.old)}`, 'info');
              fetchEducation(); // Auto-refresh
            }
          )
          .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
              log('‚úÖ Realtime connected!', 'success');
              statusEl.className = 'status success';
              statusEl.textContent = '‚úÖ Connected to Supabase Realtime';
            } else if (status === 'CHANNEL_ERROR') {
              log('‚ùå Realtime connection error', 'error');
              statusEl.className = 'status error';
              statusEl.textContent = '‚ùå Realtime Error - Check if Realtime is enabled in Supabase';
            } else {
              log(`‚ÑπÔ∏è Status: ${status}`, 'info');
            }
          });

      } catch (error) {
        log(`‚ùå Realtime setup error: ${error.message}`, 'error');
        statusEl.className = 'status error';
        statusEl.textContent = `‚ùå Error: ${error.message}`;
      }
    }

    // Initialize
    (async () => {
      log('üöÄ Initializing...', 'info');
      statusEl.className = 'status success';
      statusEl.textContent = '‚úÖ Connected to Supabase';
      
      await fetchEducation();
      await setupRealtime();
      
      log('‚úÖ Ready! Try toggling visibility in Admin Dashboard', 'success');
    })();
  </script>
</body>
</html>
